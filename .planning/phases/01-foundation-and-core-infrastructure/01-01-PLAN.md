---
phase: 01-foundation-and-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/ingot/__init__.py
  - src/ingot/config/__init__.py
  - src/ingot/config/crypto.py
  - src/ingot/config/manager.py
  - src/ingot/config/schema.py
  - src/ingot/cli/__init__.py
  - src/ingot/cli/setup.py
  - src/ingot/logging_config.py
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05
  - INFRA-06

must_haves:
  truths:
    - "Running `job-hunter setup` creates ~/.outreach-agent/ with config.json, .key, logs/, resume/, venues/ subdirectories"
    - "All credentials stored in config.json are Fernet-encrypted; raw plaintext never appears in config.json"
    - "The same machine key always produces the same Fernet key (deterministic derivation); decrypt(encrypt(x)) == x"
    - "Re-running setup skips fields that are already configured; only missing or invalid values are prompted"
    - "Non-interactive mode accepts ANTHROPIC_API_KEY, OPENAI_API_KEY, and GMAIL_* env vars or --non-interactive flag"
    - "After setup, a summary Rich table shows all configured services with secrets masked and log file path"
    - "Per-agent model config written to config.json; presets 'fully_free' and 'best_quality' set all agent model fields correctly"
  artifacts:
    - path: "src/ingot/config/crypto.py"
      provides: "Fernet key derivation from ~/.outreach-agent/.key, encrypt_secret(), decrypt_secret()"
      exports: ["get_fernet", "encrypt_secret", "decrypt_secret"]
    - path: "src/ingot/config/manager.py"
      provides: "ConfigManager: read/write config.json, load_or_create(), get(), set(), save()"
      exports: ["ConfigManager"]
    - path: "src/ingot/config/schema.py"
      provides: "Pydantic models for config.json structure — AppConfig, AgentConfig, SmtpConfig, ImapConfig"
      exports: ["AppConfig", "AgentConfig", "SmtpConfig", "ImapConfig"]
    - path: "src/ingot/cli/setup.py"
      provides: "setup wizard CLI command — interactive + non-interactive modes"
      exports: ["setup_app"]
    - path: "pyproject.toml"
      provides: "package metadata, dependencies, pytest config, entry point"
      contains: "asyncio_mode = \"auto\""
  key_links:
    - from: "src/ingot/config/crypto.py"
      to: "~/.outreach-agent/.key"
      via: "_load_or_create_machine_key()"
      pattern: "KEY_FILE\\.read_bytes|KEY_FILE\\.write_bytes"
    - from: "src/ingot/config/manager.py"
      to: "src/ingot/config/crypto.py"
      via: "encrypt_secret() called on every secret field before writing"
      pattern: "encrypt_secret\\("
    - from: "src/ingot/cli/setup.py"
      to: "src/ingot/config/manager.py"
      via: "ConfigManager().save() at wizard completion"
      pattern: "ConfigManager|save\\("
---

<objective>
Bootstrap the project package and build the config/encryption/setup-wizard layer — the foundation every subsequent plan depends on.

Purpose: Every agent needs to load credentials, pick an LLM backend, and know where the database lives. This plan creates that shared surface. Nothing else can run without it.
Output: Installable `ingot` package, `job-hunter setup` command, encrypted config.json, and a fully functional ConfigManager that all plans can import.
</objective>

<execution_context>
@/Users/ishansingh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ishansingh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation-and-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-and-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold, pyproject.toml, and package structure</name>
  <files>
    pyproject.toml
    src/ingot/__init__.py
    src/ingot/config/__init__.py
    src/ingot/cli/__init__.py
    src/ingot/logging_config.py
  </files>
  <action>
Create the project scaffold. The package name is `ingot`, CLI entry point is `job-hunter`.

**pyproject.toml** — use PEP 517 (hatchling or setuptools). Include:
- `[project]` section: name="ingot", version="0.1.0", requires-python=">=3.11"
- Dependencies (exact versions from research): `pydantic-ai>=1.63`, `litellm>=1.81`, `sqlmodel>=0.0.24`, `aiosqlite>=0.20`, `alembic>=1.14`, `cryptography>=44`, `tenacity>=9`, `pydantic>=2`, `typer>=0.15`, `rich>=14`, `questionary>=2`, `httpx>=0.28`, `platformdirs>=3`, `structlog>=25`, `aiosmtplib>=3`, `aioimaplib>=2`
- `[project.scripts]`: `job-hunter = "ingot.cli:app"`
- `[tool.pytest.ini_options]`: `asyncio_mode = "auto"`, `addopts = "--cov=ingot --cov-report=term-missing --cov-fail-under=70"`, `testpaths = ["tests"]`
- `[tool.coverage.run]`: `source = ["ingot"]`, `omit = ["tests/*"]`

**src/ingot/__init__.py** — set `__version__ = "0.1.0"`. Nothing else.

**src/ingot/logging_config.py** — configure structlog with:
- Processors: timestamper (ISO format), add_log_level, StackInfoRenderer, ConsoleRenderer for terminal, JSONRenderer for file
- Two handlers: stderr (WARNING+ only, human-readable) and rotating file handler at `~/.outreach-agent/logs/run-{date}.log` (DEBUG+, JSON)
- Log rotation: 5 files × 5MB each (use `logging.handlers.RotatingFileHandler`)
- Export `configure_logging(base_dir: Path, verbosity: int = 0)` where verbosity 0=WARNING, 1=INFO (-v), 2=DEBUG (-vv)
- Export `get_logger(name: str)` that returns a structlog BoundLogger

**src/ingot/cli/__init__.py** — create `app = typer.Typer(name="job-hunter")` and import the setup command. This is the entry point referenced in pyproject.toml.

Run `pip install -e ".[dev]"` after creating pyproject.toml to verify the package installs. If install fails, fix before proceeding.
  </action>
  <verify>
    <automated>python -c "import ingot; print(ingot.__version__)" && job-hunter --help</automated>
  </verify>
  <done>
    `import ingot` succeeds, `job-hunter --help` prints help text with at least the `setup` command listed. pyproject.toml exists with all required dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fernet crypto module and ConfigManager</name>
  <files>
    src/ingot/config/crypto.py
    src/ingot/config/schema.py
    src/ingot/config/manager.py
  </files>
  <action>
**src/ingot/config/crypto.py** — implement exactly the pattern from RESEARCH.md Pattern 2:

```python
KEY_FILE = Path.home() / ".outreach-agent" / ".key"
SALT = b"ingot-v1-static-salt"
PBKDF2HMAC iterations = 600_000  # NOT 1,200,000 — machine key has full entropy so lower is fine
```

- `_load_or_create_machine_key() -> bytes`: Creates KEY_FILE.parent if missing, generates `os.urandom(32)` on first run, writes it, sets `chmod 0o600`. Returns the bytes.
- `get_fernet() -> Fernet`: Derives key via PBKDF2HMAC(SHA256, length=32, salt=SALT, iterations=600_000), base64-encodes, returns Fernet instance.
- `encrypt_secret(plaintext: str) -> str`: Returns base64-encoded ciphertext string.
- `decrypt_secret(ciphertext: str) -> str`: Returns plaintext string. Raises `ConfigError` (from agents/exceptions — stub it here as `class ConfigError(Exception): pass` in a local import guard; Plan 01-04 will create the full exception hierarchy).

**src/ingot/config/schema.py** — Pydantic v2 BaseModel (NOT SQLModel table=True — this is not a DB model):

```python
class AgentConfig(BaseModel):
    model: str = "ollama/llama3.1"  # LiteLLM model string

class SmtpConfig(BaseModel):
    host: str = "smtp.gmail.com"
    port: int = 587
    username: str = ""
    password: str = ""  # Fernet-encrypted when stored

class ImapConfig(BaseModel):
    host: str = "imap.gmail.com"
    port: int = 993
    username: str = ""
    password: str = ""  # Fernet-encrypted when stored

class AppConfig(BaseModel):
    agents: dict[str, AgentConfig] = Field(default_factory=dict)
    smtp: SmtpConfig = Field(default_factory=SmtpConfig)
    imap: ImapConfig = Field(default_factory=ImapConfig)
    max_retries: int = 3
    backoff_strategy: str = "exponential"
    llm_fallback_chain: list[str] = Field(default_factory=lambda: ["claude", "openai", "ollama"])
    db_path: str = ""
    log_dir: str = ""
    resume_dir: str = ""
    venues_dir: str = ""
```

Default agent keys: `orchestrator`, `scout`, `research`, `matcher`, `writer`, `outreach`, `analyst`.

**src/ingot/config/manager.py** — `ConfigManager` class:

```python
class ConfigManager:
    def __init__(self, base_dir: Path | None = None):
        self.base_dir = base_dir or Path.home() / ".outreach-agent"
        self.config_path = self.base_dir / "config.json"

    def ensure_dirs(self) -> None:
        """Create ~/.outreach-agent/ and subdirs on first run."""
        for subdir in ["", "logs", "resume", "venues"]:
            (self.base_dir / subdir).mkdir(parents=True, exist_ok=True)
        # Set .key to 600 if it exists (crypto.py creates it on first encrypt call)

    def load(self) -> AppConfig:
        """Load and parse config.json. Returns default AppConfig if file missing."""

    def save(self, config: AppConfig) -> None:
        """Encrypt secret fields, serialize to JSON, write atomically (write to .tmp then rename)."""
        # Encrypt smtp.password and imap.password before writing
        # Atomic write: write to config_path.with_suffix('.tmp') then rename

    def get_db_path(self) -> Path:
        return self.base_dir / "outreach.db"
```

Secret encryption rule: smtp.password and imap.password are encrypted with `encrypt_secret()` before writing to disk. `load()` calls `decrypt_secret()` on those fields when reading. Store encrypted fields as `"__encrypted__:" + ciphertext` prefix so the manager knows which fields to decrypt.
  </action>
  <verify>
    <automated>python -c "
from ingot.config.crypto import encrypt_secret, decrypt_secret
s = encrypt_secret('test-api-key')
assert decrypt_secret(s) == 'test-api-key', 'roundtrip failed'
from ingot.config.manager import ConfigManager
from ingot.config.schema import AppConfig
import tempfile, pathlib
with tempfile.TemporaryDirectory() as d:
    cm = ConfigManager(base_dir=pathlib.Path(d))
    cfg = cm.load()
    cfg.smtp.password = 'my-secret'
    cm.save(cfg)
    cfg2 = cm.load()
    assert cfg2.smtp.password == 'my-secret', 'persist/reload failed'
print('OK')
"
    </automated>
  </verify>
  <done>
    Fernet encrypt/decrypt roundtrip passes. ConfigManager saves with encrypted passwords and reloads them correctly. config.json on disk contains `__encrypted__:` prefix on secret fields, not plaintext.
  </done>
</task>

<task type="auto">
  <name>Task 3: Setup wizard CLI command</name>
  <files>
    src/ingot/cli/setup.py
  </files>
  <action>
Implement `job-hunter setup` using Typer + questionary. Honor ALL locked decisions from CONTEXT.md exactly.

**Command signature:**
```python
@app.command()
def setup(
    non_interactive: bool = typer.Option(False, "--non-interactive", help="Read credentials from env vars"),
    preset: str | None = typer.Option(None, "--preset", help="'fully_free' or 'best_quality'"),
    verbose: int = typer.Option(0, "-v", count=True, max=2),
):
```

**Interactive flow** (one credential at a time, input masking, inline validation):
1. Load existing config (if ~/.outreach-agent/config.json exists, skip fields already set)
2. Prompt for Gmail SMTP username (if not set): `questionary.text("Gmail address for sending:")`
3. Prompt for Gmail SMTP/IMAP password (if not set): `questionary.password("Gmail App Password:")` — validate not empty
4. If preset not specified, ask which LLM backend: `questionary.select("LLM setup:", choices=["fully_free (all Ollama)", "best_quality (Claude Sonnet for Writer+Research, Haiku for rest)", "custom"])`
5. If "custom" or no preset: for each of 7 agents, prompt for model string with default shown
6. For Claude backend: prompt for `ANTHROPIC_API_KEY` (masked), validate starts with "sk-ant-"
7. For OpenAI backend: prompt for `OPENAI_API_KEY` (masked), validate starts with "sk-"
8. For Ollama: no key needed, show note "Ensure Ollama is running at localhost:11434"
9. Prompt for mailing address (for CAN-SPAM footer): `questionary.text("Physical mailing address (required for CAN-SPAM):")`
10. Call `cm.ensure_dirs()`, save config
11. Print Rich summary table: columns = Service, Status, Value (masked) — include log file path in table footer

**Non-interactive mode**: Read from env vars: `ANTHROPIC_API_KEY`, `OPENAI_API_KEY`, `GMAIL_USERNAME`, `GMAIL_APP_PASSWORD`. Missing required vars cause a clear error message, not a crash. Apply preset from `--preset` flag.

**Preset logic:**
- `fully_free`: all 7 agents → `ollama/llama3.1`
- `best_quality`: writer → `anthropic/claude-3-5-sonnet-20241022`, research → `anthropic/claude-3-5-sonnet-20241022`, all others → `anthropic/claude-3-haiku-20240307`

**Re-run behavior**: Load existing config first. For each prompt, if the field already has a non-empty value, skip it entirely (do not re-ask). Print "[already configured]" next to skipped fields in the summary table.

**Error display**: Use `rich.console.Console(stderr=True)` for errors so they don't pollute stdout. All tracebacks go to log file only; terminal shows: `[Setup] Something went wrong. Full error logged to {log_path}`.
  </action>
  <verify>
    <automated>
# Non-interactive test with env vars
ANTHROPIC_API_KEY=sk-ant-test GMAIL_USERNAME=test@gmail.com GMAIL_APP_PASSWORD=test123 job-hunter setup --non-interactive --preset fully_free && python -c "
from ingot.config.manager import ConfigManager
import pathlib
# Verify config was written
cfg = ConfigManager().load()
print('agents:', list(cfg.agents.keys()))
assert len(cfg.agents) == 7
assert cfg.agents['scout'].model == 'ollama/llama3.1'
print('OK')
"
    </automated>
  </verify>
  <done>
    `job-hunter setup --non-interactive --preset fully_free` with env vars creates config.json with 7 agent entries all set to `ollama/llama3.1`. Interactive mode prompts work (test manually after). Summary table displays with masked secrets.
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
# Package installs and CLI works
job-hunter --help
job-hunter setup --help

# Crypto roundtrip
python -c "from ingot.config.crypto import encrypt_secret, decrypt_secret; assert decrypt_secret(encrypt_secret('hello')) == 'hello'; print('crypto OK')"

# ConfigManager persist/reload
python -c "
from ingot.config.manager import ConfigManager
from ingot.config.schema import AppConfig
import tempfile, pathlib
with tempfile.TemporaryDirectory() as d:
    cm = ConfigManager(base_dir=pathlib.Path(d))
    cm.ensure_dirs()
    cfg = cm.load()
    cfg.smtp.password = 'secret'
    cm.save(cfg)
    import json
    raw = json.loads((pathlib.Path(d) / 'config.json').read_text())
    assert '__encrypted__:' in raw['smtp']['password'], 'password not encrypted on disk'
    cfg2 = cm.load()
    assert cfg2.smtp.password == 'secret', 'decrypt failed on reload'
    print('ConfigManager OK')
"

# Non-interactive setup
ANTHROPIC_API_KEY=sk-ant-test GMAIL_USERNAME=test@gmail.com GMAIL_APP_PASSWORD=testpw job-hunter setup --non-interactive --preset best_quality
```
</verification>

<success_criteria>
- `job-hunter setup` command exists and runs without error in both interactive and non-interactive modes
- All 6 INFRA requirements (INFRA-01 through INFRA-06) are addressed: directory structure, Fernet encryption, PBKDF2HMAC key derivation, setup wizard, presets, per-agent config
- Fernet encrypt/decrypt roundtrip is deterministic and correct
- Encrypted secrets on disk carry `__encrypted__:` prefix; never stored as plaintext
- Re-run skips already-configured fields
- Non-interactive mode reads from env vars
- Both presets (`fully_free`, `best_quality`) set agent model fields correctly
- `pyproject.toml` has correct dependencies and pytest config with `asyncio_mode = "auto"`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-core-infrastructure/01-01-SUMMARY.md` with:
- What was built (files created, key decisions)
- Key interfaces exported (ConfigManager, AppConfig, AgentConfig, encrypt_secret, decrypt_secret)
- Any deviations from this plan and why
- Config.json schema (the final field names used)
</output>
