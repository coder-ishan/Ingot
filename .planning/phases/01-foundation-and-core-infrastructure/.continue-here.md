---
phase: 01-foundation-and-core-infrastructure
status: in_progress
last_updated: 2026-02-26T05:30:39.872Z
---

<current_state>
Mid-execution of Phase 1. Wave 2 (01-02, 01-03) is complete and PRs raised. Now handling Copilot review feedback on PRs #2 and #3 before proceeding to Wave 3 (01-04 agent framework).

We were about to implement fixes across both worktrees in parallel when context ran out.
</current_state>

<completed_work>

- **01-01** (feature/01-01-config-crypto) — COMPLETE. PR #1 raised → main.
  - pyproject.toml, Fernet crypto, ConfigManager, setup wizard CLI, logging
  - Committed: a53d0a8, b4b1f02, fa2d6b7, f42c225
  - SUMMARY.md written

- **01-02** (feature/01-02-db-models) — COMPLETE (code). PR #2 raised → feature/01-01-config-crypto.
  - All 11 SQLModel models, async engine + WAL, BaseRepository, Alembic + initial migration
  - Worktree at: /tmp/ingot-worktrees/01-02
  - SUMMARY.md written
  - **Copilot review comments pending** — see below

- **01-03** (feature/01-03-llm-client) — COMPLETE (code). PR #3 raised → feature/01-01-config-crypto.
  - LLMClient (litellm + tenacity retry + XML fallback), exception hierarchy, schemas
  - Worktree at: /tmp/ingot-worktrees/01-03
  - SUMMARY.md written
  - **Copilot review comments pending** — see below
</completed_work>

<remaining_work>

### Immediate: Fix Copilot review feedback on PR #2 (01-02 worktree)

1. **engine.py line 12** — use `as_posix()` for cross-platform path safety:
   ```python
   return f"sqlite+aiosqlite:///{(base_dir / 'outreach.db').as_posix()}"
   ```
2. **repositories/base.py line 36** — `await self.session.delete(obj)` is wrong. `delete()` is sync:
   ```python
   self.session.delete(obj)  # no await
   ```
3. **engine.py line 39** — module-level `engine = create_engine(_get_database_url())` calls ConfigManager at import time; make lazy:
   - Change to `_engine = None` sentinel + `get_engine()` getter
   - Update `AsyncSessionLocal`, `get_session()`, `init_db()` to use `get_engine()`
   - Update `__init__.py` to export `get_engine` instead of `engine`
4. **models.py JSON columns** — add `nullable=False` to all `Column(JSON)` fields (skip MutableList — we never mutate in-place, always reassign)
5. **alembic/env.py line 13** — add `sys.path` insertion so `alembic upgrade head` works without editable install:
   ```python
   import sys
   from pathlib import Path
   sys.path.insert(0, str(Path(__file__).resolve().parent.parent / "src"))
   ```

### Immediate: Fix Copilot review feedback on PR #3 (01-03 worktree)

1. **client.py line 86** — `finish_reason` unused; add `logger.debug("LLM finish_reason: %s", finish_reason)`
2. **schemas.py** — `LLMMessage` unused in client; wire into `complete()` type hint as `list[LLMMessage | dict]` or remove `LLMRequest`/`LLMResponse` (keep `LLMMessage` as documented contract, remove the other two as truly unused)
3. **exceptions.py line 51** — rename `ValidationError` → `InputValidationError` to avoid shadowing `pydantic.ValidationError`; update `__init__.py` export
4. **fallback.py line 41** — `__origin__ is list` misses `Optional[list[str]]`; fix with `typing.get_origin/get_args`:
   ```python
   import typing
   origin = typing.get_origin(annotation)
   if origin is list:
       ...
   elif origin is typing.Union:
       args = typing.get_args(annotation)
       if any(typing.get_origin(a) is list for a in args):
           # treat as list
   ```

### After fixes: Wave 3

- **01-04** (feature/01-04-agent-framework) — needs code from BOTH 01-02 AND 01-03
  - Branch strategy: `git checkout -b feature/01-04-agent-framework feature/01-03-llm-client` then `git merge feature/01-02-db-models`
  - PR target: feature/01-03-llm-client (or whichever user merged last)
  - Builds: PydanticAI v1.x agent shells (7 agents), AgentDeps, registry, httpx singleton, asyncio dispatcher, SMTP/IMAP stubs

### After Wave 3: Wave 4

- **01-05** (feature/01-05-test-suite) — full pytest suite, 80%+ coverage, zero real API calls
</remaining_work>

<decisions_made>

- **One branch per plan** with stacked PRs — each PR targets the previous plan's branch (not main)
- **Sequential within Wave 2 for branching** — 01-02 and 01-03 both branch from 01-01; 01-04 will merge both
- **MutableList skipped** — we always reassign list fields, never mutate in-place; Copilot's MutableList suggestion correctly pushed back
- **Subagents can't run** — gsd-executor subagents get tool permissions denied when working outside project dir (`/tmp/ingot-worktrees/`). All execution done directly in main context.
- **Worktrees for parallel work** — git worktrees at `/tmp/ingot-worktrees/01-02` and `/tmp/ingot-worktrees/01-03` for isolating parallel branch work
- **pip3 --break-system-packages** — required on this macOS setup for installing packages
- **PYTHONPATH=src** — needed when running verification scripts from worktree dirs since packages aren't always editable-installed
</decisions_made>

<blockers>

- **Subagent tool permissions** — gsd-executor agents fail when pointed to `/tmp/` worktree paths (Read + Bash denied). Workaround: execute plans directly in main orchestrator context.
- **Worktrees exist at `/tmp/ingot-worktrees/`** — they persist between sessions (confirmed: /tmp/ingot-worktrees/01-02 and /01-03 exist with all committed code). But `/tmp` is cleared on reboot — if rebooted, recreate with `git worktree add`.
</blockers>

<context>
The workflow is: write files → verify with PYTHONPATH=src python3 -c "..." → git -C /tmp/ingot-worktrees/01-0X commit → push → gh pr create.

For Wave 3 (01-04), the tricky part is that it depends on BOTH 01-02 and 01-03 which are parallel branches both off 01-01. The merge strategy is:
  1. `git checkout -b feature/01-04-agent-framework feature/01-03-llm-client`
  2. `git merge feature/01-02-db-models` (no conflicts expected — completely different files)
  3. Execute 01-04 plan
  4. PR → feature/01-03-llm-client

The 01-04 plan builds: AgentDeps dataclass, AgentBase protocol, 7 PydanticAI v1.x agent shells (Orchestrator, Scout, Research, Matcher, Writer, Outreach, Analyst), AGENT_REGISTRY, httpx.AsyncClient singleton, asyncio.Queue dispatcher, SMTP/IMAP stubs. All under 250 lines for Orchestrator.
</context>

<next_action>
1. Apply PR #2 fixes to /tmp/ingot-worktrees/01-02 (5 items above), commit, push --force-with-lease
2. Apply PR #3 fixes to /tmp/ingot-worktrees/01-03 (4 items above), commit, push --force-with-lease
3. Do both in parallel (they're in separate worktrees, no conflicts)
4. Then proceed to Wave 3: create feature/01-04-agent-framework merging both wave 2 branches
</next_action>
